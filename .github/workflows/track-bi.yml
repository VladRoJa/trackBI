name: track-bi

on:
  workflow_dispatch:
  schedule:
    - cron: "0 15 * * *"   # Ajusta horario UTC cuando ya tengas todo fino

jobs:
  run-track-bi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies + Playwright browsers
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          python -m playwright install --with-deps

      - name: Create .env file for scripts
        run: |
          cat << 'EOF' > .env
          DIRECCION_USER=${{ secrets.DIRECCION_USER }}
          DIRECCION_PASS=${{ secrets.DIRECCION_PASS }}
          DIRECCION_LOGIN_URL=${{ secrets.DIRECCION_LOGIN_URL }}

          DIRECCION_REPORTE_URL=${{ secrets.DIRECCION_REPORTE_URL }}
          KPI_DESEMPENO_URL=${{ secrets.KPI_DESEMPENO_URL }}
          KPI_VENTAS_NUEVAS_SOCIOS_URL=${{ secrets.KPI_VENTAS_NUEVAS_SOCIOS_URL }}

          REPORTES_URL=${{ secrets.REPORTES_URL }}

          DIRECCION_OUTPUT_DIR=scripts/data/direccion_ingresos
          KPI_DESEMPENO_OUTPUT_DIR=scripts/data/kpi_desempeno
          KPI_VENTAS_NUEVOS_SOCIOS_OUTPUT_DIR=scripts/data/kpi_ventas_nuevos_socios
          DESCARGAS_OUTPUT_DIR=scripts/data/descargas

          SHOW_BROWSER=0
          EOF

      - name: Create output folders
        run: |
          mkdir -p scripts/data/direccion_ingresos
          mkdir -p scripts/data/kpi_desempeno
          mkdir -p scripts/data/kpi_ventas_nuevos_socios
          mkdir -p scripts/data/descargas

      # ---------- 1) Script de Dirección + KPIs ----------
      - name: Ejecutar reporte Dirección
        working-directory: scripts
        run: |
          python reporte_direccion_ingresos.py

      # ---------- 2) Script de descargas ----------
      - name: Ejecutar descargas (corte caja, venta total, cargos recurrentes)
        working-directory: scripts
        run: |
          python reporte_descargas.py
