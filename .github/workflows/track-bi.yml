name: track-bi

on:
  workflow_dispatch:      # para correrlo a mano
  schedule:               # luego aquí pones tu horario real
    - cron: "0 15 * * *"  # ej. 7 AM de Tijuana (~UTC-6/7 según horario)

jobs:
  run-track-bi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          python -m playwright install --with-deps

      - name: Create .env file for scripts
        run: |
          cat << 'EOF' > .env
          DIRECCION_USER=${{ secrets.DIRECCION_USER }}
          DIRECCION_PASS=${{ secrets.DIRECCION_PASS }}
          DIRECCION_LOGIN_URL=${{ secrets.DIRECCION_LOGIN_URL }}

          DIRECCION_REPORTE_URL=${{ secrets.DIRECCION_REPORTE_URL }}
          KPI_DESEMPENO_URL=${{ secrets.KPI_DESEMPENO_URL }}

          # URLs de módulo de reportes (corte caja / venta total / cargos)
          REPORTES_URL=${{ secrets.REPORTES_URL }}

          # Carpetas donde guardan los archivos (dentro del repo)
          DIRECCION_OUTPUT_DIR=data/direccion_ingresos
          KPI_DESEMPENO_OUTPUT_DIR=data/kpi_desempeno
          KPI_VENTAS_NUEVOS_SOCIOS_OUTPUT_DIR=data/kpi_ventas_nuevos_socios
          DESCARGAS_OUTPUT_DIR=data/descargas

          # Playwright siempre en headless en Actions
          SHOW_BROWSER=0
          EOF

      - name: Create output folders
        run: |
          mkdir -p data/direccion_ingresos
          mkdir -p data/kpi_desempeno
          mkdir -p data/kpi_ventas_nuevos_socios
          mkdir -p data/descargas

      - name: Run Python scripts
        working-directory: scripts
        run: |
          python reporte_direccion_ingresos.py
          python reporte_descargas.py
