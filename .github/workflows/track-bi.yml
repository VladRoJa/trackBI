name: track-bi

on:
  workflow_dispatch:
  schedule:
    # 1) Todos los d√≠as a las 7:00 am (Mexicali = UTC-8) -> 15:00 UTC
    - cron: "*/5 * * * *"
    # 2) √öltimo d√≠a del mes a las 11:00 pm (Mexicali)
    #    Se programa a las 07:00 UTC del d√≠a 1 siguiente
    #- cron: "0 7 1 * *"

permissions:
  contents: write    

jobs:
  run-track-bi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # para poder hacer push sin bronca

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies + Playwright browsers
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          python -m playwright install --with-deps

      - name: Create .env file for scripts
        run: |
          cat << 'EOF' > .env
          DIRECCION_USER=${{ secrets.DIRECCION_USER }}
          DIRECCION_PASS=${{ secrets.DIRECCION_PASS }}
          DIRECCION_LOGIN_URL=${{ secrets.DIRECCION_LOGIN_URL }}
          DIRECCION_REPORTE_URL=${{ secrets.DIRECCION_REPORTE_URL }}
          KPI_DESEMPENO_URL=${{ secrets.KPI_DESEMPENO_URL }}
          REPORTES_URL=${{ secrets.REPORTES_URL }}

          # En Actions siempre headless
          SHOW_BROWSER=0
          EOF

      - name: Create output folders
        run: |
          mkdir -p data/direccion_ingresos
          mkdir -p data/kpi_desempeno
          mkdir -p data/kpi_ventas_nuevos_socios
          mkdir -p data/descargas

      # ---------- 1) Script de Direcci√≥n + KPIs ----------
      - name: Ejecutar reporte Direcci√≥n
        working-directory: scripts
        run: |
          python reporte_direccion_ingresos.py

      # ---------- 2) Script de descargas ----------
      - name: Ejecutar descargas (corte caja, venta total, cargos recurrentes)
        working-directory: scripts
        run: |
          python reporte_descargas.py

      - name: Commit & push updated Excel files
        run: |
          echo "üîç Estado antes de commit:"
          git status

          # Config identidad del bot
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Agregar los Excel generados
          git add \
            data/direccion_ingresos/*.xlsx \
            data/kpi_desempeno/*.xlsx \
            data/kpi_ventas_nuevos_socios/*.xlsx \
            data/descargas/*.xlsx || echo "Nada que agregar"

          # Si no hay nada staged, salir sin error
          if git diff --cached --quiet; then
            echo "‚úÖ No hay cambios nuevos en los Excel, no se hace commit."
            exit 0
          fi

          # Commit
          MSG="chore: auto-update track BI $(date -u +'%Y-%m-%d %H:%M UTC')"
          git commit -m "$MSG"

          echo "üì• Haciendo pull --rebase de origin/main antes del push..."
          git pull --rebase origin main

          echo "üöÄ Haciendo push a main..."
          git push origin main
