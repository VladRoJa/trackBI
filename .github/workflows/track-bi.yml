name: track-bi

on:
  workflow_dispatch:
  schedule:
    - cron: "0 15 * * *"   # Ajusta horario UTC cuando ya tengas todo fino

permissions:
  contents: write    

jobs:
  run-track-bi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies + Playwright browsers
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          python -m playwright install --with-deps

      - name: Create .env file for scripts
        run: |
          cat << 'EOF' > .env
          DIRECCION_USER=${{ secrets.DIRECCION_USER }}
          DIRECCION_PASS=${{ secrets.DIRECCION_PASS }}
          DIRECCION_LOGIN_URL=${{ secrets.DIRECCION_LOGIN_URL }}

          DIRECCION_REPORTE_URL=${{ secrets.DIRECCION_REPORTE_URL }}
          KPI_DESEMPENO_URL=${{ secrets.KPI_DESEMPENO_URL }}

          REPORTES_URL=${{ secrets.REPORTES_URL }}

          DIRECCION_OUTPUT_DIR=scripts/data/direccion_ingresos
          KPI_DESEMPENO_OUTPUT_DIR=scripts/data/kpi_desempeno
          KPI_VENTAS_NUEVOS_SOCIOS_OUTPUT_DIR=scripts/data/kpi_ventas_nuevos_socios

          SHOW_BROWSER=0
          EOF


      - name: Create output folders
        run: |
          mkdir -p scripts/data/direccion_ingresos
          mkdir -p scripts/data/kpi_desempeno
          mkdir -p scripts/data/kpi_ventas_nuevos_socios
          mkdir -p scripts/data/descargas

      # ---------- 1) Script de Direcci√≥n + KPIs ----------
      - name: Ejecutar reporte Direcci√≥n
        working-directory: scripts
        run: |
          python reporte_direccion_ingresos.py

      # ---------- 2) Script de descargas ----------
      - name: Ejecutar descargas (corte caja, venta total, cargos recurrentes)
        working-directory: scripts
        run: |
          python reporte_descargas.py

      - name: Commit & push updated Excel files
        run: |
          echo "üîç Estado antes de commit:"
          git status

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add \
            scripts/data/direccion_ingresos/*.xlsx \
            scripts/data/kpi_desempeno/*.xlsx \
            scripts/data/kpi_ventas_nuevos_socios/*.xlsx \
            scripts/data/descargas/*.xlsx || echo "Nada que agregar"

          if git diff --cached --quiet; then
            echo "‚úÖ No hay cambios nuevos en los Excel, no se hace commit."
            exit 0
          fi

          MSG="chore: auto-update track BI $(date -u +'%Y-%m-%d %H:%M UTC')"
          git commit -m "$MSG"
          echo "üöÄ Haciendo push a main..."
          git push origin main

